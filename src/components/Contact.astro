---
const { site } = Astro.props;
import IconBadge from "./IconBadge.astro";
const c = site.contact ?? {};
const formEndpoint = c.formEndpoint ?? "";
---
<section id="contact" class="nb-anchor-offset nb-section">
  <div class="container">
    <div class="row g-4 align-items-stretch nb-contact-grid">
      <div class="col-lg-5 d-flex">
        <div class="w-100 d-flex flex-column">
          <h2 class="section-title fw-bold">{c.title}</h2>
          <p class="text-secondary mt-3">{c.lead}</p>

          <div class="p-4 nb-card mt-3 nb-contact-info-card d-flex flex-column w-100">
            <div class="nb-contact-item mb-3">
              <div class="nb-icon-wrap"><IconBadge name="phone" /></div>
              <div>
                <div class="small text-secondary">{c.phoneLabel}</div>
                <a href={c.phoneHref}>{c.phoneText}</a>
              </div>
            </div>

            <div class="nb-contact-item mb-3">
              <div class="nb-icon-wrap"><IconBadge name="mail" /></div>
              <div>
                <div class="small text-secondary">{c.emailLabel}</div>
                <a href={c.emailHref}>{c.emailText}</a>
              </div>
            </div>

            <div class="nb-contact-item">
              <div class="nb-icon-wrap"><IconBadge name="clock" /></div>
              <div>
                <div class="small text-secondary">Hours of operation</div>
                <div class="fw-semibold">Monday–Friday, 9:00 AM – 5:00 PM</div>
              </div>
            </div>

            <a
              class="btn nb-btn-primary mt-3 align-self-start"
              href={site.bookings?.url}
              target="_blank"
              rel="noopener"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true" class="nb-inline-icon">
                <rect x="3" y="5" width="18" height="16" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2" />
                <path d="M16 3v4M8 3v4M3 10h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
              Book a consult
            </a>
          </div>
        </div>
      </div>

      <div class="col-lg-7 d-flex">
        <div class="p-4 nb-card h-100 w-100 d-flex flex-column nb-contact-form-card">
          <h3 class="h5 fw-bold mb-3">Send a message</h3>

          <form id="contactForm" class="row g-3" novalidate>
            <input type="hidden" id="contactEndpoint" value={formEndpoint} />
            <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" class="d-none" aria-hidden="true" />

            <div class="col-md-6">
              <label class="form-label" for="contact-name">Name</label>
              <input id="contact-name" class="form-control" name="name" autocomplete="name" maxlength="120" required />
            </div>

            <div class="col-md-6">
              <label class="form-label" for="contact-email">Email</label>
              <input id="contact-email" class="form-control" name="email" type="email" inputmode="email" autocomplete="email" maxlength="160" required />
            </div>

            <div class="col-md-6">
              <label class="form-label" for="contact-phone">Phone</label>
              <input id="contact-phone" class="form-control" name="phone" type="tel" inputmode="tel" autocomplete="tel" maxlength="30" />
            </div>

            <div class="col-md-6">
              <label class="form-label" for="contact-org">Practice / Organization</label>
              <input id="contact-org" class="form-control" name="org" autocomplete="organization" maxlength="160" />
            </div>

            <div class="col-12">
              <label class="form-label" for="contact-message">Message</label>
              <textarea id="contact-message" class="form-control" name="message" rows="5" maxlength="4000" required></textarea>
            </div>

            <div class="col-12 d-flex gap-2 flex-wrap align-items-center nb-contact-actions">
              <button id="contactSubmitBtn" class="btn nb-btn-primary" type="submit">
                <svg viewBox="0 0 24 24" aria-hidden="true" class="nb-inline-icon">
                  <path d="M3 11.5 21 3l-8.5 18-1.9-6.6L3 11.5Z" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linejoin="round" />
                  <path d="M10.6 14.4 21 3" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" />
                </svg>
                <span id="contactSubmitLabel">Send message</span>
              </button>
              <a class="btn btn-outline-secondary rounded-pill" href={c.emailHref}>Email using my mail app</a>
            </div>

            <div class="col-12">
              <span id="contactStatus" class="small text-secondary" role="status" aria-live="polite"></span>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('contactForm');
    const statusEl = document.getElementById('contactStatus');
    const endpoint = (document.getElementById('contactEndpoint')?.value || '').trim();
    const submitBtn = document.getElementById('contactSubmitBtn');
    const submitLabel = document.getElementById('contactSubmitLabel');

    const setStatus = (message, kind = 'neutral') => {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.classList.remove('text-secondary', 'text-success', 'text-danger');
      if (kind === 'success') statusEl.classList.add('text-success');
      else if (kind === 'error') statusEl.classList.add('text-danger');
      else statusEl.classList.add('text-secondary');
    };

    const getFormspreeErrorMessage = (data, fallbackStatus) => {
      const list = Array.isArray(data?.errors)
        ? data.errors.map((e) => e?.message).filter(Boolean)
        : [];
      const direct = typeof data?.error === 'string' ? [data.error] : [];
      const detail = [...list, ...direct].join(' ').trim();
      if (detail) return detail;
      return fallbackStatus ? `Request failed (${fallbackStatus}).` : 'Request failed.';
    };

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!form.reportValidity()) return;

      if (!endpoint || endpoint.includes('example.com') || endpoint.includes('PASTE-POWER-AUTOMATE')) {
        setStatus('Contact form is not connected yet. Please use the email button for now.', 'error');
        return;
      }

      const fd = new FormData(form);
      if ((fd.get('_gotcha') || '').toString().trim()) {
        form.reset();
        setStatus('', 'neutral');
        alert('Thanks! Your message was sent successfully.');
        window.location.reload();
        return;
      }

      const originalLabel = submitLabel?.textContent || 'Send message';
      submitBtn?.setAttribute('disabled', 'disabled');
      if (submitLabel) submitLabel.textContent = 'Sending...';
      setStatus('Sending your message...', 'neutral');

      try {
        let response;
        let errorMessage = '';

        if (/formspree\.io/i.test(endpoint)) {
          // JSON submit is the most reliable pattern for Formspree AJAX submissions.
          const payload = {
            name: (fd.get('name') || '').toString(),
            email: (fd.get('email') || '').toString(),
            _replyto: (fd.get('email') || '').toString(),
            phone: (fd.get('phone') || '').toString(),
            org: (fd.get('org') || '').toString(),
            message: (fd.get('message') || '').toString(),
            _subject: 'New website message from NexGen Binary LLC',
            _gotcha: (fd.get('_gotcha') || '').toString(),
          };

          response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify(payload),
          });

          const contentType = response.headers.get('content-type') || '';
          if (contentType.includes('application/json')) {
            const data = await response.json();
            if (!response.ok) {
              errorMessage = getFormspreeErrorMessage(data, response.status);
            }
          } else if (!response.ok) {
            const text = await response.text();
            errorMessage = text?.trim() || `Request failed (${response.status}).`;
          }
        } else {
          const payload = {
            name: fd.get('name'),
            email: fd.get('email'),
            phone: fd.get('phone'),
            organization: fd.get('org'),
            message: fd.get('message'),
            submittedAt: new Date().toISOString(),
            source: 'nexgenbinary.com',
          };

          response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            errorMessage = `Request failed (${response.status}).`;
          }
        }

        if (!response?.ok) throw new Error(errorMessage || 'submit_failed');

        form.reset();
        setStatus('', 'neutral');
        alert('Thanks! Your message was sent successfully.');
        window.location.reload();
      } catch (err) {
        const message = err instanceof Error ? err.message : '';
        if (/spam/i.test(message)) {
          setStatus('Formspree flagged this as spam. Enable CAPTCHA + Restrict to Domain in Formspree, then try again.', 'error');
        } else if (/domain/i.test(message) || /origin/i.test(message)) {
          setStatus('Form domain restriction blocked this submission. Check Formspree “Restrict to Domain” settings.', 'error');
        } else {
          setStatus('Unable to send right now. Please try again or use the email button.', 'error');
        }
        // Helpful while testing in the browser
        console.error('Contact form submit failed:', message || err);
      } finally {
        submitBtn?.removeAttribute('disabled');
        if (submitLabel) submitLabel.textContent = originalLabel;
      }
    });
  </script>

  <style>
    #contact .nb-contact-info-card,
    #contact .nb-contact-form-card {
      min-width: 0;
      overflow: hidden;
    }

    #contact .nb-contact-actions {
      row-gap: 0.5rem;
    }

    #contact .nb-contact-actions .btn {
      max-width: 100%;
    }

    #contact .nb-contact-item a,
    #contact .nb-contact-item .fw-semibold,
    #contact #contactStatus {
      overflow-wrap: anywhere;
    }
  </style>
</section>
