---
const { site } = Astro.props;
import IconBadge from "./IconBadge.astro";
const c = site.contact ?? {};
const formEndpoint = c.formEndpoint ?? "";
const hcaptchaSiteKey = c.hcaptchaSiteKey ?? "";
---
<section id="contact" class="nb-anchor-offset nb-section">
  <div class="container">
    <div class="row g-4 align-items-stretch nb-contact-grid">
      <div class="col-lg-5 d-flex">
        <div class="w-100 d-flex flex-column">
          <h2 class="section-title fw-bold">{c.title}</h2>
          <p class="text-secondary mt-3">{c.lead}</p>

          <div class="p-4 nb-card mt-3 nb-contact-info-card d-flex flex-column w-100">
            <div class="nb-contact-item mb-3">
              <div class="nb-icon-wrap"><IconBadge name="phone" /></div>
              <div>
                <div class="small text-secondary">{c.phoneLabel}</div>
                <a href={c.phoneHref}>{c.phoneText}</a>
              </div>
            </div>

            <div class="nb-contact-item mb-3">
              <div class="nb-icon-wrap"><IconBadge name="mail" /></div>
              <div>
                <div class="small text-secondary">{c.emailLabel}</div>
                <a href={c.emailHref}>{c.emailText}</a>
              </div>
            </div>

            <div class="nb-contact-item">
              <div class="nb-icon-wrap"><IconBadge name="clock" /></div>
              <div>
                <div class="small text-secondary">Hours of operation</div>
                <div class="fw-semibold">Monday–Friday, 9:00 AM – 5:00 PM</div>
              </div>
            </div>

            <a
              class="btn nb-btn-primary mt-3 align-self-start"
              href={site.bookings?.url}
              target="_blank"
              rel="noopener"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true" class="nb-inline-icon">
                <rect x="3" y="5" width="18" height="16" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2" />
                <path d="M16 3v4M8 3v4M3 10h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
              Book a consult
            </a>
          </div>
        </div>
      </div>

      <div class="col-lg-7 d-flex">
        <div class="p-4 nb-card h-100 w-100 d-flex flex-column nb-contact-form-card">
          <h3 class="h5 fw-bold mb-3">Send a message</h3>

          <form id="contactForm" class="row g-3" novalidate>
            <input type="hidden" id="contactEndpoint" value={formEndpoint} />
            <input type="hidden" id="contactHcaptchaSiteKey" value={hcaptchaSiteKey} />
            <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" class="d-none" aria-hidden="true" />
            <input type="hidden" name="_subject" value="New website message from NexGen Binary LLC" />

            <div class="col-md-6">
              <label class="form-label" for="contact-name">Name <span class="text-danger" aria-hidden="true">*</span></label>
              <input id="contact-name" class="form-control" name="name" autocomplete="name" maxlength="120" required aria-required="true" aria-describedby="contact-name-error" />
              <div id="contact-name-error" class="small text-danger mt-1" hidden></div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="contact-email">Email <span class="text-danger" aria-hidden="true">*</span></label>
              <input id="contact-email" class="form-control" name="email" type="email" inputmode="email" autocomplete="email" maxlength="160" required aria-required="true" aria-describedby="contact-email-error" />
              <div id="contact-email-error" class="small text-danger mt-1" hidden></div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="contact-phone">Phone</label>
              <input id="contact-phone" class="form-control" name="phone" type="tel" inputmode="tel" autocomplete="tel" maxlength="30" />
            </div>

            <div class="col-md-6">
              <label class="form-label" for="contact-org">Practice / Organization</label>
              <input id="contact-org" class="form-control" name="org" autocomplete="organization" maxlength="160" />
            </div>

            <div class="col-12">
              <label class="form-label" for="contact-message">Message <span class="text-danger" aria-hidden="true">*</span></label>
              <textarea id="contact-message" class="form-control" name="message" rows="5" maxlength="4000" required aria-required="true" aria-describedby="contact-message-error"></textarea>
              <div id="contact-message-error" class="small text-danger mt-1" hidden></div>
            </div>

            {hcaptchaSiteKey && (
              <div class="col-12">
                <div class="form-label mb-2">Verification <span class="text-danger" aria-hidden="true">*</span></div>
                <div class="h-captcha" data-sitekey={hcaptchaSiteKey}></div>
                <div id="contact-captcha-error" class="small text-danger mt-1" hidden></div>
              </div>
            )}

            <div class="col-12 d-flex gap-2 flex-wrap align-items-center nb-contact-actions">
              <button id="contactSubmitBtn" class="btn nb-btn-primary" type="submit">
                <svg viewBox="0 0 24 24" aria-hidden="true" class="nb-inline-icon">
                  <path d="M3 11.5 21 3l-8.5 18-1.9-6.6L3 11.5Z" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linejoin="round" />
                  <path d="M10.6 14.4 21 3" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" />
                </svg>
                <span id="contactSubmitLabel">Send message</span>
              </button>
              <a class="btn btn-outline-secondary rounded-pill" href={c.emailHref}>Email using my mail app</a>
            </div>

            <div class="col-12">
              <span id="contactStatus" class="small text-secondary" role="status" aria-live="polite"></span>
            </div>

            <div id="contactSuccessModal" class="nb-contact-modal" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="contactSuccessTitle">
              <div class="nb-contact-modal__backdrop"></div>
              <div class="nb-contact-modal__panel" role="document">
                <h4 id="contactSuccessTitle" class="h6 fw-bold mb-2">Message sent</h4>
                <p class="mb-3 text-secondary">Thanks! Your message was sent successfully.</p>
                <div class="d-flex justify-content-end">
                  <button id="contactSuccessOk" type="button" class="btn nb-btn-primary">OK</button>
                </div>
              </div>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>

  {hcaptchaSiteKey && <script src="https://js.hcaptcha.com/1/api.js" async defer></script>}

  <script>
    const form = document.getElementById('contactForm');
    const statusEl = document.getElementById('contactStatus');
    const endpoint = (document.getElementById('contactEndpoint')?.value || '').trim();
    const submitBtn = document.getElementById('contactSubmitBtn');
    const submitLabel = document.getElementById('contactSubmitLabel');
    const successModal = document.getElementById('contactSuccessModal');
    const successModalOk = document.getElementById('contactSuccessOk');
    const hcaptchaSiteKey = (document.getElementById('contactHcaptchaSiteKey')?.value || '').trim();
    const captchaErrorEl = document.getElementById('contact-captcha-error');


    const openSuccessModal = () => {
      if (!successModal) {
        alert('Thanks! Your message was sent successfully.');
        window.location.reload();
        return;
      }
      successModal.hidden = false;
      successModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('nb-contact-modal-open');
      requestAnimationFrame(() => successModal.classList.add('is-open'));
      successModalOk?.focus();
    };

    const closeSuccessModalAndRefresh = () => {
      if (successModal) {
        successModal.classList.remove('is-open');
        successModal.setAttribute('aria-hidden', 'true');
        successModal.hidden = true;
      }
      document.body.classList.remove('nb-contact-modal-open');
      window.location.reload();
    };

    const setStatus = (message, kind = 'neutral') => {
      if (!statusEl) return;
      statusEl.textContent = message;
      statusEl.classList.remove('text-secondary', 'text-success', 'text-danger');
      if (kind === 'success') statusEl.classList.add('text-success');
      else if (kind === 'error') statusEl.classList.add('text-danger');
      else statusEl.classList.add('text-secondary');
    };

    const clearCaptchaError = () => {
      if (!captchaErrorEl) return;
      captchaErrorEl.textContent = '';
      captchaErrorEl.hidden = true;
    };

    const showCaptchaError = (message) => {
      if (!captchaErrorEl) return;
      captchaErrorEl.textContent = message;
      captchaErrorEl.hidden = false;
    };

    const getHcaptchaToken = () => {
      const tokenEl = form?.querySelector('textarea[name="h-captcha-response"], input[name="h-captcha-response"]');
      return (tokenEl?.value || '').toString().trim();
    };

    const requiredFieldLabels = {
      'contact-name': 'Name',
      'contact-email': 'Email',
      'contact-message': 'Message',
    };

    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    const getFieldErrorEl = (input) => {
      if (!input?.id) return null;
      return document.getElementById(`${input.id}-error`);
    };

    const clearFieldError = (input) => {
      if (!input) return;
      const errorEl = getFieldErrorEl(input);
      if (errorEl) {
        errorEl.textContent = '';
        errorEl.hidden = true;
      }
      input.removeAttribute('aria-invalid');
      input.classList.remove('is-invalid');
    };

    const showFieldError = (input, message) => {
      if (!input) return;
      const errorEl = getFieldErrorEl(input);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.hidden = false;
      }
      input.setAttribute('aria-invalid', 'true');
      input.classList.add('is-invalid');
    };

    const validateField = (input) => {
      if (!input) return true;
      const fieldLabel = requiredFieldLabels[input.id] || 'This field';
      const value = (input.value || '').trim();

      if (input.hasAttribute('required') && !value) {
        showFieldError(input, `${fieldLabel} is required.`);
        return false;
      }

      if (input.type === 'email' && value && !emailPattern.test(value)) {
        showFieldError(input, 'Enter a valid email address.');
        return false;
      }

      clearFieldError(input);
      return true;
    };

    const validateForm = () => {
      let firstInvalid = null;
      let allValid = true;

      Object.keys(requiredFieldLabels).forEach((fieldId) => {
        const input = document.getElementById(fieldId);
        const valid = validateField(input);
        if (!valid) {
          allValid = false;
          if (!firstInvalid) firstInvalid = input;
        }
      });

      if (!allValid && firstInvalid) firstInvalid.focus();
      return allValid;
    };

    Object.keys(requiredFieldLabels).forEach((fieldId) => {
      const input = document.getElementById(fieldId);
      if (!input) return;
      input.addEventListener('blur', () => validateField(input));
      input.addEventListener('input', () => {
        const hasValue = (input.value || '').trim().length > 0;
        if (input.type === 'email' || hasValue || input.classList.contains('is-invalid')) {
          validateField(input);
        } else {
          clearFieldError(input);
        }
      });
    });

    successModalOk?.addEventListener('click', () => {
      closeSuccessModalAndRefresh();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && successModal && !successModal.hidden) {
        closeSuccessModalAndRefresh();
      }
    });

    const getFormspreeErrorMessage = (data, fallbackStatus) => {
      const list = Array.isArray(data?.errors)
        ? data.errors.map((e) => e?.message).filter(Boolean)
        : [];
      const direct = typeof data?.error === 'string' ? [data.error] : [];
      const detail = [...list, ...direct].join(' ').trim();
      if (detail) return detail;
      return fallbackStatus ? `Request failed (${fallbackStatus}).` : 'Request failed.';
    };


    const cleanUiError = (value) => {
      const text = (value || '').toString().replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
      return text.slice(0, 180);
    };

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!validateForm()) {
        setStatus('Please fill in the required fields and try again.', 'error');
        return;
      }

      if (!endpoint || endpoint.includes('example.com') || endpoint.includes('PASTE-POWER-AUTOMATE')) {
        setStatus('Contact form is not connected yet. Please use the email button for now.', 'error');
        return;
      }

      clearCaptchaError();
      const hasHcaptchaWidget = !!form.querySelector('.h-captcha');
      if (hasHcaptchaWidget && !hcaptchaSiteKey) {
        setStatus('hCaptcha site key is missing in site settings. Add your hCaptcha Site Key and try again.', 'error');
        showCaptchaError('hCaptcha site key is missing.');
        return;
      }

      const fd = new FormData(form);
      if (hasHcaptchaWidget && !getHcaptchaToken()) {
        setStatus('Please complete the CAPTCHA before sending.', 'error');
        showCaptchaError('Please complete the CAPTCHA before sending.');
        return;
      }
      if ((fd.get('_gotcha') || '').toString().trim()) {
        form.reset();
        setStatus('', 'neutral');
        openSuccessModal();
        return;
      }

      const originalLabel = submitLabel?.textContent || 'Send message';
      submitBtn?.setAttribute('disabled', 'disabled');
      if (submitLabel) submitLabel.textContent = 'Sending...';
      setStatus('Sending your message...', 'neutral');

      try {
        let response;
        let errorMessage = '';

        if (/formspree\.io/i.test(endpoint)) {
          // Use FormData + Accept JSON for Formspree (avoids extra CORS preflight and matches their standard form-post flow).
          fd.set('_replyto', (fd.get('email') || '').toString());
          fd.set('_subject', 'New website message from NexGen Binary LLC');

          response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              Accept: 'application/json',
            },
            body: fd,
          });

          const contentType = response.headers.get('content-type') || '';
          if (contentType.includes('application/json')) {
            const data = await response.json();
            if (!response.ok) {
              errorMessage = getFormspreeErrorMessage(data, response.status);
            }
          } else if (!response.ok) {
            const text = await response.text();
            errorMessage = text?.trim() || `Request failed (${response.status}).`;
          }

          if (!response.ok && !errorMessage && response.status === 429) {
            errorMessage = 'Too many submissions. Please wait a moment and try again.';
          }
        } else {
          const payload = {
            name: fd.get('name'),
            email: fd.get('email'),
            phone: fd.get('phone'),
            organization: fd.get('org'),
            message: fd.get('message'),
            submittedAt: new Date().toISOString(),
            source: 'nexgenbinary.com',
          };

          response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            errorMessage = `Request failed (${response.status}).`;
          }
        }

        if (!response?.ok) throw new Error(errorMessage || 'submit_failed');

        form.reset();
        Object.keys(requiredFieldLabels).forEach((fieldId) => {
          const input = document.getElementById(fieldId);
          clearFieldError(input);
        });
        clearCaptchaError();
        if (window.hcaptcha && typeof window.hcaptcha.reset === 'function') {
          try { window.hcaptcha.reset(); } catch {}
        }
        setStatus('', 'neutral');
        openSuccessModal();
      } catch (err) {
        const message = err instanceof Error ? err.message : '';
        const uiMessage = cleanUiError(message);
        if (/secret/i.test(message) && /captcha|hcaptcha/i.test(message)) {
          setStatus('hCaptcha is enabled, but the hCaptcha Secret Key is still missing in Formspree CAPTCHA settings.', 'error');
          showCaptchaError('Form configuration incomplete (missing hCaptcha secret key).');
        } else if (/(site\s*key|sitekey)/i.test(message) && /captcha|hcaptcha/i.test(message)) {
          setStatus('hCaptcha site key is missing or invalid in the website settings. Add the hCaptcha Site Key and try again.', 'error');
          showCaptchaError('hCaptcha site key is missing or invalid.');
        } else if (/spam|captcha/i.test(message)) {
          setStatus('Formspree flagged this submission. Complete the hCaptcha check and try again, or use the email button.', 'error');
          showCaptchaError('Please complete the CAPTCHA and submit again.');
        } else if (/domain|origin|referer|referrer/i.test(message)) {
          setStatus('Form domain restriction blocked this submission. Check Formspree Project Settings → Restrict to Domain.', 'error');
        } else if (/inactive|confirm|verify/i.test(message)) {
          setStatus('Formspree form setup is not fully activated yet. Confirm/verify the form in Formspree, then try again.', 'error');
        } else if (uiMessage) {
          setStatus(`Unable to send: ${uiMessage}`, 'error');
        } else {
          setStatus('Unable to send right now. Please try again or use the email button.', 'error');
        }
        // Helpful while testing in the browser
        console.error('Contact form submit failed:', message || err);
      } finally {
        submitBtn?.removeAttribute('disabled');
        if (submitLabel) submitLabel.textContent = originalLabel;
      }
    });
  </script>

  <style>
    #contact .nb-contact-info-card,
    #contact .nb-contact-form-card {
      min-width: 0;
      overflow: hidden;
    }

    #contact .nb-contact-actions {
      row-gap: 0.5rem;
    }

    #contact .nb-contact-actions .btn {
      max-width: 100%;
    }

    #contact .h-captcha {
      max-width: 100%;
      overflow-x: auto;
    }

    #contact .nb-contact-item a,
    #contact .nb-contact-item .fw-semibold,
    #contact #contactStatus {
      overflow-wrap: anywhere;
    }

    #contact .nb-contact-modal {
      position: fixed;
      inset: 0;
      z-index: 1100;
      display: grid;
      place-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease;
      padding: 1rem;
    }

    #contact .nb-contact-modal.is-open {
      opacity: 1;
      pointer-events: auto;
    }

    #contact .nb-contact-modal__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(8, 20, 40, 0.55);
    }

    #contact .nb-contact-modal__panel {
      position: relative;
      width: min(420px, 100%);
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 18px 50px rgba(10, 25, 48, 0.22);
      border: 1px solid rgba(18, 110, 184, 0.15);
      padding: 1rem 1rem 0.875rem;
      transform: translateY(8px) scale(0.98);
      transition: transform 0.18s ease;
    }

    #contact .nb-contact-modal.is-open .nb-contact-modal__panel {
      transform: translateY(0) scale(1);
    }

    #contact .nb-contact-modal__panel .btn {
      min-width: 90px;
    }

    :global(body.nb-contact-modal-open) {
      overflow: hidden;
    }
  </style>
</section>
