---
import site from "../content/site.json";
import IconBadge from "./IconBadge.astro";

const contact = site.contact ?? {};

const phone = contact.phone ?? "804-000-0000";
const phoneHref = contact.phoneHref ?? `tel:${String(phone).replace(/[^\d+]/g, "")}`;
const email = contact.email ?? "info@nexgenbinary.com";
const emailHref = contact.emailHref ?? `mailto:${email}`;
const bookingUrl = contact.bookingUrl ?? "#";
const bookingLabel = contact.bookingLabel ?? "Book a consult";
const bookingHelpText = contact.bookingHelpText ?? "Prefer a scheduled conversation? Use booking to pick a time that works for your office.";
const googleBusinessUrl = contact.googleBusinessUrl ?? "";
const googleBusinessLabel = contact.googleBusinessLabel ?? "Find us on Google";
const responseBadge = contact.responseBadge ?? "Typical response: within 1 business day";
const formEndpoint = contact.formEndpoint ?? contact.formspreeEndpoint ?? "";
const hcaptchaSiteKey = contact.hcaptchaSiteKey ?? "";
const emailMailtoHref = `mailto:${email}?subject=${encodeURIComponent("NexGen Binary website inquiry")}`;
---

<section id="contact" class="nb-section nb-section-soft nb-contact">
  <div class="nb-shell">
    <div class="nb-contact-wrap">
      <div class="nb-contact-left">
        <div class="nb-contact-intro">
          <h2 class="nb-section-title">{contact.title ?? "Contact"}</h2>
          {contact.lead && <p class="nb-section-lead nb-contact-lead">{contact.lead}</p>}
          <div class="nb-contact-chip">{responseBadge}</div>
        </div>

        <div class="nb-card nb-direct-card">
          <div class="nb-direct-title">Direct contact</div>

          <div class="nb-direct-row">
            <IconBadge name="phone" />
            <div class="nb-direct-copy">
              <div class="nb-direct-label">Phone</div>
              <a href={phoneHref}>{phone}</a>
            </div>
          </div>

          <div class="nb-direct-row">
            <IconBadge name="mail" />
            <div class="nb-direct-copy">
              <div class="nb-direct-label">Email</div>
              <a href={emailHref}>{email}</a>
            </div>
          </div>

          <div class="nb-direct-row">
            <IconBadge name="clock" />
            <div class="nb-direct-copy">
              <div class="nb-direct-label">{contact.hoursLabel ?? "Hours of operation"}</div>
              <div class="nb-direct-text">{contact.hours ?? "Mondayâ€“Friday, 9:00 AM â€“ 5:00 PM"}</div>
            </div>
          </div>

          {googleBusinessUrl && (
            <div class="nb-direct-row">
              <IconBadge name="pin" />
              <div class="nb-direct-copy">
                <div class="nb-direct-label">Google business page</div>
                <a href={googleBusinessUrl} target="_blank" rel="noopener noreferrer">{googleBusinessLabel}</a>
              </div>
            </div>
          )}

          <div class="nb-contact-side-actions">
            <a class="nb-contact-btn-primary" href={bookingUrl} target="_blank" rel="noopener noreferrer">
              <span class="nb-btn-icon" aria-hidden="true">ðŸ“…</span>
              <span>{bookingLabel}</span>
            </a>
            <p class="nb-contact-side-note">{bookingHelpText}</p>
          </div>
        </div>
      </div>

      <div class="nb-card nb-contact-form-card">
        <h3 class="nb-contact-form-title">Send a message</h3>
        <p class="nb-contact-form-sub">Tell us about your practice, systems, or support needs. Required fields are marked with <span>*</span>.</p>

        <div id="nb-form-alert" class="nb-form-alert" hidden></div>

        <form
          id="nb-contact-form"
          class="nb-contact-form"
          action={formEndpoint || emailHref}
          method="POST"
          data-endpoint={formEndpoint}
          data-hcaptcha={hcaptchaSiteKey}
          novalidate
        >
          <input type="hidden" name="_subject" value="New website inquiry from NexGen Binary" />

          <div class="nb-form-grid">
            <label class="nb-form-field">
              <span>Name <strong>*</strong></span>
              <input class="nb-input" type="text" name="name" required autocomplete="name" />
            </label>
            <label class="nb-form-field">
              <span>Email <strong>*</strong></span>
              <input class="nb-input" type="email" name="email" required autocomplete="email" />
            </label>
            <label class="nb-form-field">
              <span>Phone</span>
              <input class="nb-input" type="tel" name="phone" autocomplete="tel" />
            </label>
            <label class="nb-form-field">
              <span>Practice / Organization</span>
              <input class="nb-input" type="text" name="organization" autocomplete="organization" />
            </label>
            <label class="nb-form-field nb-form-field-full">
              <span>Message <strong>*</strong></span>
              <textarea class="nb-input nb-textarea" name="message" required rows="5"></textarea>
            </label>
          </div>

          {hcaptchaSiteKey && (
            <div class="nb-form-field nb-form-field-full nb-captcha-field">
              <span>Verification <strong>*</strong></span>
              <div class="nb-hcaptcha-wrap">
                <div class="h-captcha" data-sitekey={hcaptchaSiteKey}></div>
              </div>
            </div>
          )}

          <div class="nb-form-actions">
            <button id="nb-send-btn" class="nb-contact-btn-primary" type="submit">
              <span class="nb-btn-icon" aria-hidden="true">âœˆ</span>
              <span>Send message</span>
            </button>
            <a class="nb-contact-btn-secondary" href={emailMailtoHref}>
              <span>Email using my mail app</span>
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="nb-contact-modal" class="nb-modal-overlay" hidden>
    <div class="nb-modal-card" role="dialog" aria-modal="true" aria-labelledby="nb-contact-modal-title">
      <h4 id="nb-contact-modal-title">Message sent</h4>
      <p>Thanks â€” your message has been sent. Weâ€™ll follow up soon.</p>
      <div class="nb-modal-actions">
        <button id="nb-contact-modal-ok" class="nb-contact-btn-primary nb-modal-ok" type="button">OK</button>
      </div>
    </div>
  </div>

  {hcaptchaSiteKey && <script is:inline src="https://js.hcaptcha.com/1/api.js" async defer></script>}

  <script is:inline>
    (() => {
      const form = document.getElementById('nb-contact-form');
      if (!form) return;

      const alertBox = document.getElementById('nb-form-alert');
      const sendBtn = document.getElementById('nb-send-btn');
      const modal = document.getElementById('nb-contact-modal');
      const modalOk = document.getElementById('nb-contact-modal-ok');
      const endpoint = form.dataset.endpoint || '';
      const hcaptchaKey = form.dataset.hcaptcha || '';

      const setAlert = (message) => {
        if (!alertBox) return;
        if (!message) {
          alertBox.hidden = true;
          alertBox.textContent = '';
          return;
        }
        alertBox.hidden = false;
        alertBox.textContent = message;
      };

      const validateRequired = () => {
        let valid = true;
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach((field) => {
          const empty = !String(field.value || '').trim();
          field.classList.toggle('is-invalid', empty);
          if (empty) valid = false;
        });

        const emailField = form.querySelector('input[name="email"]');
        if (emailField && emailField.value && !emailField.checkValidity()) {
          emailField.classList.add('is-invalid');
          valid = false;
        }

        if (hcaptchaKey) {
          const tokenField = form.querySelector('textarea[name="h-captcha-response"]');
          const token = tokenField ? tokenField.value.trim() : '';
          if (!token) {
            valid = false;
            setAlert('Please complete the verification check before sending.');
          }
        }

        if (valid) setAlert('');
        return valid;
      };

      form.addEventListener('input', (e) => {
        if (e.target && e.target.classList && e.target.classList.contains('is-invalid')) {
          if (String(e.target.value || '').trim()) e.target.classList.remove('is-invalid');
        }
      });

      form.addEventListener('submit', async (e) => {
        if (!endpoint) {
          return; // fall back to native submit/mailto if no endpoint is configured
        }

        e.preventDefault();
        if (!validateRequired()) {
          if (!alertBox.hidden) return;
          setAlert('Please complete the required fields.');
          return;
        }

        const originalLabel = sendBtn ? sendBtn.innerHTML : '';
        if (sendBtn) {
          sendBtn.disabled = true;
          sendBtn.innerHTML = '<span>Sending...</span>';
        }

        try {
          const resp = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Accept': 'application/json' },
            body: new FormData(form)
          });

          if (!resp.ok) {
            throw new Error('Request failed');
          }

          setAlert('');
          form.reset();
          form.querySelectorAll('.is-invalid').forEach((el) => el.classList.remove('is-invalid'));
          if (window.hcaptcha) {
            try { window.hcaptcha.reset(); } catch (_) {}
          }
          if (modal) modal.hidden = false;
        } catch (err) {
          setAlert('Unable to send right now. Please try again or use the mail app button.');
        } finally {
          if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalLabel;
          }
        }
      });

      const closeModal = () => {
        if (!modal) return;
        modal.hidden = true;
        window.location.reload();
      };

      if (modalOk) modalOk.addEventListener('click', closeModal);
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });
      }
    })();
  </script>
</section>
