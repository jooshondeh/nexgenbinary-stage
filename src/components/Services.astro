---
import IconBadge from './IconBadge.astro';
const { site } = Astro.props;
const groups = site?.services?.groups ?? [];
const mainGroups = groups.slice(0, 4);
const networkGroup = groups[4];

const iconFor = (title = '') => {
  const t = title.toLowerCase();
  if (t.includes('managed')) return 'monitor';
  if (t.includes('emr') || t.includes('clinical')) return 'tools';
  if (t.includes('microsoft') || t.includes('cloud')) return 'cloud';
  if (t.includes('security')) return 'lockshield';
  if (t.includes('network') || t.includes('wifi') || t.includes('voip') || t.includes('camera')) return 'network';
  return 'tools';
};

const serviceItemText = (item) => {
  if (item == null) return '';
  if (typeof item === 'string' || typeof item === 'number') return String(item);
  if (Array.isArray(item)) {
    return item.map(serviceItemText).filter(Boolean).join(' ');
  }
  if (typeof item === 'object') {
    for (const key of ['text', 'label', 'title', 'name', 'value', 'description', 'desc']) {
      if (typeof item[key] === 'string' || typeof item[key] === 'number') return String(item[key]);
    }
    const joined = Object.values(item)
      .filter((v) => typeof v === 'string' || typeof v === 'number')
      .map((v) => String(v).trim())
      .filter(Boolean)
      .join(' ');
    return joined;
  }
  return String(item);
};

const normalizeItems = (items = []) => (items ?? []).map(serviceItemText).filter(Boolean);

const networkItems = normalizeItems(networkGroup?.items ?? []);
const networkSplit = Math.ceil(networkItems.length / 2);
---
<section id="services" class="nb-section nb-anchor-offset">
  <div class="nb-shell">
    <h2 class="nb-section-title">{site?.services?.title || 'Services'}</h2>
    <div class="nb-services-grid">
      {mainGroups.map((group) => (
        <article class="nb-service-card nb-hover-pop">
          <div class="nb-service-head">
            <div class="nb-icon-wrap"><IconBadge name={iconFor(group.title)} /></div>
            <h3>{group.title}</h3>
          </div>
          <ul>
            {normalizeItems(group.items ?? []).map((item) => <li>{item}</li>)}
          </ul>
        </article>
      ))}

      {networkGroup && (
        <article class="nb-service-card nb-service-card-wide nb-hover-pop nb-service-wide">
          <div class="nb-service-head">
            <div class="nb-icon-wrap"><IconBadge name={iconFor(networkGroup.title)} /></div>
            <h3>{networkGroup.title}</h3>
          </div>
          <div class="nb-service-cols">
            <ul>
              {networkItems.slice(0, networkSplit).map((item) => <li>{item}</li>)}
            </ul>
            <ul>
              {networkItems.slice(networkSplit).map((item) => <li>{item}</li>)}
            </ul>
          </div>
        </article>
      )}
    </div>
  </div>
</section>
