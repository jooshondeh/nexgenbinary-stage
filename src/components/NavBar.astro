---
import IconBadge from "./IconBadge.astro";

const { site } = Astro.props;
const brand = site?.brand ?? {};
const phoneText = site?.contact?.phoneDisplay ?? "804-000-0000";
const phoneHref = "#contact";

const navItems = [
  { id: "home", label: "Home" },
  { id: "services", label: "Services" },
  { id: "pricing", label: "Pricing" },
  { id: "who-we-serve", label: "Who We Serve" },
  { id: "about", label: "About" },
  { id: "contact", label: "Contact" },
];
---
<header class="nb-navbar-wrap">
  <div class="nb-shell nb-navbar">
    <a class="nb-brand" href="#home" aria-label={`${brand.name} home`}>
      <img src="/Company_logo.png?v=32" alt="NexGen Binary logo" class="nb-brand-logo" width="48" height="48" />
      <span class="nb-brand-text">
        <span class="nb-brand-name">{brand.name}</span>
        <span class="nb-brand-slogan">{brand.slogan}</span>
      </span>
    </a>

    <button class="nb-nav-toggle" type="button" aria-expanded="false" aria-controls="nb-nav-menu" aria-label="Open menu">
      <span></span><span></span><span></span>
    </button>

    <nav id="nb-nav-menu" class="nb-nav" aria-label="Primary">
      <ul class="nb-nav-list">
        {navItems.map((item) => (
          <li><a class="nb-nav-link" href={`#${item.id}`} data-target={item.id}>{item.label}</a></li>
        ))}
      </ul>
      <a class="nb-phone-btn nb-pop" href={phoneHref} data-target="contact">
        <IconBadge name="phone" class="inline" />
        <span>{phoneText}</span>
      </a>
    </nav>
  </div>
</header>

<script is:inline>
  (() => {
    const header = document.querySelector('.nb-navbar-wrap');
    const nav = document.getElementById('nb-nav-menu');
    const toggle = document.querySelector('.nb-nav-toggle');
    const links = Array.from(document.querySelectorAll('.nb-nav-link, .nb-phone-btn'));
    if (!header || !nav || !toggle || !links.length) return;

    toggle.addEventListener('click', () => {
      const open = nav.classList.toggle('is-open');
      toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      document.body.classList.toggle('nb-menu-open', open);
    });

    const closeMenu = () => {
      nav.classList.remove('is-open');
      toggle.setAttribute('aria-expanded', 'false');
      document.body.classList.remove('nb-menu-open');
    };

    const offset = () => (header instanceof HTMLElement ? header.offsetHeight : 76) + 10;

    links.forEach((a) => {
      a.addEventListener('click', (e) => {
        const targetId = a.getAttribute('data-target');
        if (!targetId) return;
        const el = document.getElementById(targetId);
        if (!el) return;
        e.preventDefault();
        const top = el.getBoundingClientRect().top + window.scrollY - offset();
        window.history.replaceState(null, '', `#${targetId}`);
        window.scrollTo({ top, behavior: 'smooth' });
        closeMenu();
      });
    });

    const sections = ['home', 'services', 'pricing', 'who-we-serve', 'about', 'contact']
      .map((id) => document.getElementById(id))
      .filter(Boolean);

    const setActive = (id) => {
      links.forEach((a) => {
        const match = a.getAttribute('data-target') === id;
        a.classList.toggle('is-active', match);
      });
    };

    const updateActive = () => {
      const y = window.scrollY + offset() + 40;
      let current = 'home';
      for (const sec of sections) {
        if (sec.offsetTop <= y) current = sec.id;
      }
      setActive(current);
    };

    window.addEventListener('scroll', updateActive, { passive: true });
    window.addEventListener('resize', updateActive);
    window.addEventListener('hashchange', updateActive);
    window.addEventListener('load', () => {
      closeMenu();
      if (!window.scrollY) setActive('home');
      updateActive();
    });
    updateActive();
  })();
</script>
